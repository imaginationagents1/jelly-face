<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Jelly Face</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=0.7, user-scalable=no">

    <link rel="stylesheet" href="./style.css">
    <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">

    <script src="thirdparty/gl-matrix-min.js"  type="text/javascript"></script>
    <script src="thirdparty/stats.min.js"  type="text/javascript"></script>

    <script src="js/time.js"           type="text/javascript"></script>
    <script src="js/texture.js"        type="text/javascript"></script>
    <script src="js/mesh.js"           type="text/javascript"></script>
    <script src="js/framebuffer.js"    type="text/javascript"></script>
    <script src="js/material.js"       type="text/javascript"></script>
    <script src="js/batched-cubes.js"  type="text/javascript"></script>
    <script src="js/vbo-loader.js"     type="text/javascript"></script>
    <script src="js/pullcube.js" type="text/javascript"></script>
    <script src="js/app.js" type="text/javascript"></script>

    <!-- Fragment shader program -->


    <script id="face-vs" type="x-shader/x-vertex">#version 300 es
        precision highp float;
        precision mediump int;
        precision highp sampler2D;

        layout( location = 1) in vec2 aTexcoord;
        layout( location = 2) in float aVertexID;

        uniform sampler2D uPosTex;
        uniform sampler2D uVelTex;
        uniform vec2 uTexelSize;

        uniform float uImageSize;

        uniform mat4 uMMatrix;
        uniform mat4 uVMatrix;
        uniform mat4 uPMatrix;

        out vec2 vTexcoord;
        out vec3 vColor;

        void main(void) {
            vTexcoord.xy = aTexcoord.xy;

            vec2 uv = (vec2(mod(aVertexID, uImageSize), floor( aVertexID / uImageSize)) + 0.5 ) / uImageSize;
            vec3 pos = texture(uPosTex, uv.xy).xyz;
            vColor = pos;
            
            gl_Position = uPMatrix * uVMatrix * vec4(pos.xyz, 1.0);          
        }

    </script>

    <script id="face-fs" type="x-shader/x-fragment">#version 300 es
        precision highp float;

        uniform sampler2D uColorTex;

        in vec2 vTexcoord;
        in vec3 vColor;

        layout(location = 0) out vec4 position;
        layout(location = 1) out vec4 color;


        void main(void) {
            color = texture(uColorTex, vec2(vTexcoord.x, 1.0 - vTexcoord.y)) * 0.5;
            position = vec4(vColor, 1.0);
        }

    </script>

    <script id="faceShadows-fs" type="x-shader/x-fragment">#version 300 es
        precision highp float;

        uniform sampler2D uColorTex;

        in vec2 vTexcoord;
        in vec3 vColor;

        layout(location = 0) out vec4 position;
        layout(location = 1) out vec4 color;

        void main(void) {
            color = texture(uColorTex, vec2(vTexcoord.x, 1.0 - vTexcoord.y)) * 0.5;
            position = vec4(vColor, 1.0);
        }

    </script>

    <script id="initPos-vs" type="x-shader/x-vertex">#version 300 es
        precision highp float;

        layout( location = 0) in vec3 aPos;
        layout( location = 2) in float aVertexID;

        uniform float uImageSize;

        uniform mat4 uMMatrix;

        out vec4 vColor;

        void main(void) {
            gl_PointSize = 1.0;
            vColor = uMMatrix * vec4(aPos.xyz, 1.0);

            vec2 uv = ( vec2(mod(aVertexID, uImageSize), floor( aVertexID / uImageSize)) + 0.5 ) / uImageSize;
            gl_Position = vec4(uv.xy*2.0 - 1.0, 0.0, 1.0);
        }

    </script>

    <script id="vColor-fs" type="x-shader/x-fragment">#version 300 es
        precision highp float;

        in vec2 vTexcoord;
        in vec4 vColor;
        in vec3 vPos;

        out vec4 color;
        void main(void) {
            color = vColor;
        }
    </script>

    <script id="pos-fs" type="x-shader/x-fragment">#version 300 es
        precision highp float;
        precision highp sampler2D;
       
        uniform sampler2D uPosTex;
        uniform sampler2D uVelTex;

        uniform float uImageSize;
        uniform float uDeltaTime;

        in vec2 vTextureCoord;

        out vec4 color;

        void main(void) {
            vec3 lastPos = texture(uPosTex, vTextureCoord.xy).xyz;
            vec3 vel = texture(uVelTex, vTextureCoord.xy).xyz;

            vec4 c = vec4(lastPos + vel * uDeltaTime, 1.0);  
            
            color = c;
        }

    </script>

    <script id="vel-vs" type="x-shader/x-vertex">#version 300 es
        precision highp float;
        precision highp sampler2D;

        layout( location = 0) in vec3 aPos;
        layout( location = 2) in float aVertexID;

        uniform sampler2D uPosTex;
        uniform sampler2D uVelTex;
        uniform sampler2D uGrabTex;

        uniform float uImageSize;
        uniform float uDeltaTime;

        uniform vec3 uMousePos;
        uniform float uAspect;
        uniform float uRadius;

        uniform mat4 uMMatrix;
        uniform mat4 uVMatrix;
        uniform mat4 uPMatrix;

        uniform mat4 uInvMVPMatrix;

        out vec4 vColor;


        void main(void) {
            gl_PointSize = 1.0;

            vec2 uv = (vec2(mod(aVertexID, uImageSize), floor( aVertexID / uImageSize)) + 0.5 ) / uImageSize;

            vec4 dPos = uMMatrix * vec4(aPos.xyz, 1.0); 

            vec3 pos = texture(uPosTex, uv.xy).xyz;
            vec3 vel = texture(uVelTex, uv.xy).xyz;
            vel = vel.xyz - vel.xyz * uDeltaTime * 3.0;

            float grab = texture(uGrabTex, uv.xy).x;

            vec4 scrPos = uPMatrix * uVMatrix * vec4(pos, 1.0);
            scrPos.xyz /= scrPos.w;
            scrPos.xyz = scrPos.xyz * 0.5 + 0.5;

            vec4 mousePos = uInvMVPMatrix * vec4(uMousePos.xy, 0.0, 1.0);
            mousePos.xyz /= mousePos.w;
            
            vec3 off = scrPos.xyz - vec3(uMousePos.xy, -1.0);
            off.z = 0.0;

            float sqDist = length(off);

            vec3 scrVel = (off * 1.0 / max(sqDist, 0.1))  * uDeltaTime;

            float pull = sqDist * 4.0;
            pull = pull * pull * 50.0;
            scrVel = scrVel * (1.0 - grab) - ( off * 3.0) * grab;

            vec4 wVel = (uInvMVPMatrix * vec4(scrVel.xyz, 0.0));
            vel += wVel.xyz;

            vec3 adjOff =  (dPos.xyz - pos.xyz) * 2.0;
            vel.xyz += adjOff;
          
            vColor = vec4(vel, 1.0);

            gl_Position = vec4(uv.xy*2.0 - 1.0, 0.0, 1.0);
        }

    </script>

    <script id="grab-vs" type="x-shader/x-vertex">#version 300 es
        precision highp float;

        layout( location = 2) in float aVertexID;

        uniform sampler2D uPosTex;
        uniform sampler2D uScreenPosTex;

        uniform float uImageSize;

        uniform vec3 uMousePos;
        uniform float uAspect;
        uniform float uRadius;

        uniform mat4 uMMatrix;
        uniform mat4 uVMatrix;
        uniform mat4 uPMatrix;

        out vec4 vColor;

        void main(void) {
            gl_PointSize = 1.0;

            vec2 uv = (vec2(mod(aVertexID, uImageSize), floor( aVertexID / uImageSize)) + 0.5 ) / uImageSize;

            vec3 pos = texture(uPosTex, uv.xy).xyz;
            vec3 hoverPos = texture(uScreenPosTex, uMousePos.xy).xyz;

            vec3 off = pos.xyz - hoverPos;

            float dist = length(off);

            float strength = 1.0 - smoothstep(0.0, uRadius, dist);
            strength = strength * strength * strength * strength * strength;
            
            vColor = vec4(strength, 0.0, 1.0, 1.0);

            gl_Position = vec4(uv.xy*2.0 - 1.0, 0.0, 1.0);
        }
    </script>



    <script id="screenquad-vs" type="x-shader/x-vertex">#version 300 es
        precision highp float;

        layout( location = 0) in vec3 aPos;

        out vec2 vTextureCoord;

        void main(void)
        {
            gl_Position = vec4(aPos.xy, 1.0, 1.0);
            vTextureCoord = (aPos.xy + vec2(1.0, 1.0)) * 0.5;
        }
    </script>

    <script id="floor-vs" type="x-shader/x-vertex">#version 300 es
        precision highp float;
        precision lowp sampler2D;

        layout( location = 0) in vec3 aPos;

        uniform mat4 uMMatrix;
        uniform mat4 uVMatrix;
        uniform mat4 uPMatrix;

        out vec4 vPos;

        void main(void) {
            vPos = uMMatrix * vec4(aPos, 1.0);
            gl_Position = uPMatrix * uVMatrix * vPos;
        }

    </script>

    <script id="floor-fs" type="x-shader/x-fragment">#version 300 es
        precision mediump float;
        precision lowp sampler2D;

        in vec4 vPos;

        layout(location = 0) out vec4 position;
        layout(location = 1) out vec4 color;

        void main(void)
        {
            position = vec4(vPos.xyz, 1.0);
            color = vec4(1.0, 1.0, 1.0, 1.0);
        }
    </script>


    <script id="compose-fs" type="x-shader/x-fragment">#version 300 es
        precision highp float;
        precision highp sampler2D;

        in vec2 vTextureCoord;
        
        uniform sampler2D uPosTex;
        uniform sampler2D uColTex;
        uniform sampler2D uShadowTex;

        uniform mat4 uLightSpace;

        out vec4 color;

        const float EPSILON = 0.002;

        float calcShadowFactor( highp vec3 lightPos )
        {
            float factor = 0.0;

            int x = 0;
            int y = 0;
            //for( int x = 0; x <= 0; x++ )
            {
                //for( int y = 0; y <= 0; y++ )
                {
                    vec2 xyOff = vec2( x, y) * EPSILON;
                    vec4 shadowPos = texture(uShadowTex, lightPos.xy + xyOff );
                    
                    float alpha = shadowPos.a;

                    shadowPos = uLightSpace * vec4(shadowPos.xyz, 1.0);
                    shadowPos.xyz /= shadowPos.w;
                    //shadowPos.xyz = shadowPos.xyz * 0.5 + 0.5;
                    
                    float off = 0.0;
                    if( shadowPos.z < lightPos.z - 0.002 )
                    {
                        off =  min(abs(lightPos.z - shadowPos.z) * 30.0, 1.0);

                    }

                    factor += off * alpha;
                }
            }

            factor = factor / 1.0;

            float rad = length(lightPos.xy - vec2(0.5, 0.5));

            rad = smoothstep(0.4, 0.5, rad);
            rad *= rad;

            factor = factor * (1.0 - rad);

            return factor;

        }

        void main(void) {
            vec4 col = texture(uColTex, vTextureCoord.st);
            vec4 pos = texture(uPosTex, vTextureCoord.st);

            /*
            vec4 lightPos = uLightSpace * vec4(pos.xyz, 1.0);

            lightPos.xyz = lightPos.xyz / lightPos.w;
            lightPos.xy = lightPos.xy * 0.5 + 0.5;

            
            col.rgb *= 1.0 - calcShadowFactor(lightPos.xyz) * 0.4;
            */

            vec2 centerOffset = vec2(0.5, 0.5) - vTextureCoord.xy;
            float off = dot(centerOffset, centerOffset);
            off = 1.0 - off;
            off = off * off;
            off = off * 2.0;
            float vignette = off;

            col *= vignette;

            color = col;
        }
    </script>

    <script id="composeShadows-fs" type="x-shader/x-fragment">#version 300 es
        precision highp float;
        precision highp sampler2D;

        in vec2 vTextureCoord;
        
        uniform sampler2D uPosTex;
        uniform sampler2D uColTex;
        uniform sampler2D uShadowTex;

        uniform mat4 uLightSpace;

        out vec4 color;

        const float EPSILON = 0.002;

        float calcShadowFactor( highp vec3 lightPos )
        {
            float factor = 0.0;

            for( int x = -1; x <= 1; x++ )
            {
                for( int y = -1; y <= 1; y++ )
                {
                    vec2 xyOff = vec2( x, y) * EPSILON;
                    vec4 shadowPos = texture(uShadowTex, lightPos.xy + xyOff );
                    
                    float alpha = shadowPos.a;

                    shadowPos = uLightSpace * vec4(shadowPos.xyz, 1.0);
                    shadowPos.xyz /= shadowPos.w;
                    
                    float off = 0.0;
                    if( shadowPos.z < lightPos.z - 0.002 )
                    {
                        off =  min(abs(lightPos.z - shadowPos.z) * 30.0, 1.0);

                    }

                    factor += off * alpha;
                }
            }

            factor = factor / 9.0;

            float rad = length(lightPos.xy - vec2(0.5, 0.5));

            rad = smoothstep(0.4, 0.5, rad);
            rad *= rad;

            factor = factor * (1.0 - rad);

            return factor;

        }

        void main(void) {
            vec4 col = texture(uColTex, vTextureCoord.st);
            vec4 pos = texture(uPosTex, vTextureCoord.st);

            vec4 lightPos = uLightSpace * vec4(pos.xyz, 1.0);

            lightPos.xyz = lightPos.xyz / lightPos.w;
            lightPos.xy = lightPos.xy * 0.5 + 0.5;
        
            col.rgb *= 1.0 - calcShadowFactor(lightPos.xyz) * 0.4;

            vec2 centerOffset = vec2(0.5, 0.5) - vTextureCoord.xy;
            float off = dot(centerOffset, centerOffset);
            off = 1.0 - off;
            off = off * off;
            off = off * 2.0;
            float vignette = off;

            col *= vignette;

            color = col;
        }
    </script>


    <script id="copy-fs" type="x-shader/x-fragment">#version 300 es
        precision highp float;

        in vec2 vTextureCoord;

        uniform sampler2D uCopyTex;

        out vec4 color;

        void main(void) {
            vec4 col = texture(uCopyTex, vTextureCoord.st);
            color = col;
        }
    </script>

</head>

<body onload="start()" style="margin: 0px;touch-action:none;overflow:hidden;">
    <div class="container">
        <canvas id="glcanvas" width="1200" height="480" style="width:100%;height:100%;">
            Your browser doesn't appear to support the <code>&lt;canvas&gt;</code> element.
        </canvas>
    </div>

    <div>
        <div id="iconContainer">
            <div id="iconRow">
                <input id="icon" onclick="loadFace(0);" type="image" src="./icons/snoop.png" />
                <input id="icon" onclick="loadFace(1);" type="image" src="./icons/charlize.png" />
                <input id="icon" onclick="loadFace(2);" type="image" src="./icons/jackie.png" />
                <input id="icon" onclick="loadFace(3);" type="image" src="./icons/shatner.png" />
                <input id="icon" onclick="loadFace(4);" type="image" src="./icons/obama.png" />
                <input id="icon" onclick="loadFace(5);" type="image" src="./icons/marilyn.png" />
            </div>
        </div>
        <div id="overlaytext">
            <p id="attributions">
                <a href="https://sketchfab.com/models/27c0788205264c7bac3b734e2733413c">Snoop Dogg</a> by <a href="https://sketchfab.com/tipatat">tipatat</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0">CC Attribution</a>
            </p>
        </div>
    </div>   
</body>
</html>