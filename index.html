<!doctype html>
<html>
<head>
    <title>Jelly Face</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="stylesheet" type="text/css" href="style.css">

    <script src="thirdparty/gl-matrix-min.js"  type="text/javascript"></script>

    <script src="js/time.js"           type="text/javascript"></script>
    <script src="js/texture.js"        type="text/javascript"></script>
    <script src="js/mesh.js"           type="text/javascript"></script>
    <script src="js/framebuffer.js"    type="text/javascript"></script>
    <script src="js/material.js"       type="text/javascript"></script>
    <script src="js/batched-cubes.js"  type="text/javascript"></script>
    <script src="js/vbo-loader.js"     type="text/javascript"></script>
    <script src="js/pullcube.js" type="text/javascript"></script>
    <script src="js/app.js" type="text/javascript"></script>

    <!-- Fragment shader program -->


    <script id="face-vs" type="x-shader/x-vertex">
        precision highp float;
        precision mediump int;
        precision highp sampler2D;

        attribute vec3 aPos;
        attribute vec2 aTexcoord;
        attribute float aVertexID;

        uniform sampler2D uPosTex;
        uniform sampler2D uVelTex;
        uniform vec2 uTexelSize;

        uniform float uImageSize;

        uniform mat4 uMMatrix;
        uniform mat4 uVMatrix;
        uniform mat4 uPMatrix;

        varying vec2 vTexcoord;
        varying vec3 vColor;
        varying vec3 test;

        void main(void) {
            vTexcoord.xy = aTexcoord.xy;

            vec2 uv = vec2(mod(aVertexID, uImageSize), floor( aVertexID / uImageSize)) / uImageSize;
            vec3 pos = texture2D(uPosTex, uv.xy).xyz;
            vColor = texture2D(uVelTex, uv.xy).xyz;
            test =  abs(aPos);

            //pos = pos + aPos;
            
            gl_Position = uPMatrix * uVMatrix * uMMatrix * vec4(pos.xyz, 1.0);          
        }

    </script>

    <script id="face-fs" type="x-shader/x-fragment">
        precision highp float;

        uniform sampler2D uColorTex;

        varying vec2 vTexcoord;
        varying vec3 test;
        varying vec3 vColor;

        void main(void) {
            gl_FragColor = texture2D(uColorTex, vec2(vTexcoord.x, 1.0 - vTexcoord.y)) * 0.5;
        }

    </script>

    <script id="initPos-vs" type="x-shader/x-vertex">
        precision highp float;

        attribute vec3 aPos;
        attribute vec2 aTexcoord;
        attribute float aVertexID;

        uniform float uImageSize;

        varying vec4 vColor;
        varying vec2 vTexcoord;

        void main(void) {
            gl_PointSize = 1.0;
            vColor = vec4(aPos.xyz, 1.0);
            vTexcoord = aTexcoord;

            vec2 uv = ( vec2(mod(aVertexID, uImageSize), floor( aVertexID / uImageSize)) + 1.0 ) / uImageSize;
            gl_Position = vec4(uv.xy*2.0 - 1.0, 0.0, 1.0);
        }

    </script>

    <script id="vColor-fs" type="x-shader/x-fragment">
        precision highp float;

        varying vec2 vTexcoord;
        varying vec4 vColor;

        void main(void) {
            gl_FragColor = vColor;
        }
    </script>

    <script id="pos-fs" type="x-shader/x-fragment">
        precision highp float;
        precision highp sampler2D;
       
        uniform sampler2D uPosTex;
        uniform sampler2D uVelTex;

        uniform float uImageSize;
        uniform float uDeltaTime;

        varying vec2 vTextureCoord;

        void main(void) {
            vec3 lastPos = texture2D(uPosTex, vTextureCoord.xy).xyz;
            vec3 vel = texture2D(uVelTex, vTextureCoord.xy).xyz;

            vec4 c = vec4(lastPos + vel * uDeltaTime, 1.0);   

            gl_FragColor = c;
        }

    </script>

    <script id="vel-vs" type="x-shader/x-vertex">
        precision highp float;
        precision highp sampler2D;

        attribute vec3 aPos;
        attribute vec2 aTexcoord;
        attribute float aVertexID;

        uniform sampler2D uPosTex;
        uniform sampler2D uVelTex;

        uniform float uImageSize;
        uniform float uDeltaTime;

        uniform vec3 uMousePos;
        uniform float uAspect;
        uniform float uRadius;

        uniform mat4 uMMatrix;
        uniform mat4 uVMatrix;
        uniform mat4 uPMatrix;

        uniform mat4 uInvMVPMatrix;

        varying vec4 vColor;
        varying vec2 vTexcoord;

        void main(void) {
            gl_PointSize = 1.0;
            vTexcoord = aTexcoord;

            vec2 uv = vec2(mod(aVertexID, uImageSize), floor( aVertexID / uImageSize))/ uImageSize;

            vec4 dPos = vec4(aPos.xyz, 1.0); 

            vec3 pos = texture2D(uPosTex, uv.xy).xyz;
            vec3 vel = texture2D(uVelTex, uv.xy).xyz;
            vel = vel.xyz - vel.xyz * uDeltaTime * 2.0;

            vec4 scrPos = uPMatrix * uVMatrix * uMMatrix * vec4(pos, 1.0);
            //scrPos.xyz / scrPos.w;
            scrPos.xy = scrPos.xy * 0.5 + 0.5;
            
            vec2 off = scrPos.xy - uMousePos.xy;

            float sqDist = length(off); //dot(off, off);
            //float sqRad = uRadius * uRadius;

            vec3 scrVel = vec3(0.0, 0.0, 0.0);
            //if( sqDist < sqRad)
            {
                 scrVel.xyz = -(vec3(off, 0.0) * 5.0 / max(sqDist, 0.08))  * uDeltaTime;
                //vel += vec3(1.0, 0.0, 0.0);
            }

            vec4 wVel = (uInvMVPMatrix * vec4(scrVel.xyz, 0.0));
            


            vel += wVel.xyz;
            //vel += vec3(scrVel.xyz) * uDeltaTime;

            vec3 adjOff =  dPos.xyz - pos.xyz;
            float adjDist = length(adjOff);
            adjDist = smoothstep(adjDist, 0.01, 1.0) * adjDist;

            adjDist = adjDist*adjDist * 10.0;
            vel.xyz += adjOff;
          
            //vel = scrPos.xyz;
            vColor = vec4(vel, 1.0);

            uv.xy += (1.0 / uImageSize);
            gl_Position = vec4(uv.xy*2.0 - 1.0, 0.0, 1.0);
        }

    </script>


    <script id="screenquad-vs" type="x-shader/x-vertex">
        attribute highp vec3 aPos;

        varying highp vec2 vTextureCoord;

        void main(void)
        {
            gl_Position = vec4(aPos.xy, 1.0, 1.0);
            vTextureCoord = (aPos.xy + vec2(1.0)) * 0.5;
        }
    </script>

    <script id="velocity-fs" type="x-shader/x-fragment">
        varying highp vec2 vTextureCoord;


        uniform sampler2D uVelTex;
        uniform sampler2D uPosTex;
        uniform sampler2D uDesiredPosTex;

        uniform highp mat4 uMMatrix;
        uniform highp mat4 uVMatrix;
        uniform highp mat4 uPMatrix;

        uniform highp mat4 uInvMVPMatrix;

        uniform highp float uDeltaTime;
        uniform highp float uRandomness;
        uniform highp float uTime;
        uniform highp float uGravityScale;

        uniform highp float uImageSize;

        uniform highp float uAspect;

        uniform highp float uRadius;
        uniform highp vec3 uMousePos;

        highp float rand(highp vec2 co){
            return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
        }

        void main(void) {
            highp vec4 pos = texture2D(uPosTex, vTextureCoord.st);
            highp vec4 vel = texture2D(uVelTex, vTextureCoord.st);

            highp vec4 desPos = texture2D(uDesiredPosTex, vTextureCoord.st);

            highp vec4 scrPos = uPMatrix * uVMatrix * uMMatrix * vec4(pos.xyz, 1.0);

            scrPos.xyz /= scrPos.w;
            scrPos.xy = scrPos.xy * 0.5 + 0.5;

            highp vec2 off = scrPos.xy - uMousePos.xy;

            highp float sqDist = dot(off, off);
            highp float sqRad = uRadius * uRadius;

            highp vec2 scrVel = vec2(0.0, 0.0);


            {
                scrVel.xy = -(off * 5.0 / max(sqDist, 0.0001))  * uDeltaTime;
            }

            highp vec4 wVel = (uInvMVPMatrix * vec4(scrVel.xy, 0.0, 0.0));

            vel.xyz += wVel.xyz;

            highp vec3 adjOff =  desPos.xyz - pos.xyz;
            highp float adjDist =  length(adjOff);

            adjDist = adjDist*adjDist * 0.05;
            vel.xyz += adjOff * adjDist * uDeltaTime;

            
            vel.xyz = vel.xyz - vel.xyz * uDeltaTime * 0.3;
            
            //vel.xy += scrPos.xy;

            gl_FragColor = vel;
        }
    </script>

    <script id="position-fs" type="x-shader/x-fragment">
        varying highp vec2 vTextureCoord;

        uniform sampler2D uVelTex;
        uniform sampler2D uPosTex;

        uniform highp float uDeltaTime;
        
        highp float rand(highp vec2 co){
            return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
        }

        void main(void) {
            highp vec4 pos = texture2D(uPosTex, vTextureCoord.st);
            highp vec4 vel = texture2D(uVelTex, vTextureCoord.st);

            pos.xyz = pos.xyz + vel.xyz * uDeltaTime;
            pos.a = 1.0;

            gl_FragColor = pos;
        }
    </script>

    <script id="compose-fs" type="x-shader/x-fragment">
        varying highp vec2 vTextureCoord;

        uniform sampler2D uScrTex;
        uniform sampler2D uPosTex;
        uniform sampler2D uVelTex;

        void main(void) {
            highp vec4 col = texture2D(uScrTex, vTextureCoord.st);

            highp vec2 centerOffset = vec2(0.5) - vTextureCoord.xy;
            highp float off = dot(centerOffset, centerOffset);
            off = 1.0 - off;
            off = off * off;
            off = off * 2.0;
            highp float vignette = off;

            col *= vignette;

            gl_FragColor = col;
        }
    </script>

    <script id="copy-fs" type="x-shader/x-fragment">
        varying highp vec2 vTextureCoord;

        uniform sampler2D uCopyTex;

        void main(void) {
            highp vec4 col = texture2D(uCopyTex, vTextureCoord.st);
            gl_FragColor = col;
        }
    </script>

    <script id="initdata-fs" type="x-shader/x-fragment">
        varying highp vec2 vTextureCoord;

        uniform highp float uCubeSize;       // 64.0
        uniform highp float uLayersPerRow;   // 8
        uniform highp float uImageSize;      // 512

        highp float rand(highp vec2 co){
            return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
        }

        void main(void) {
            highp float spacing = 1.0/uLayersPerRow;
            
            highp vec3 cubePos;        
            cubePos.x = mod( vTextureCoord.x, spacing ) * uLayersPerRow;
            cubePos.y = mod( vTextureCoord.y, spacing ) * uLayersPerRow;
            cubePos.z = floor( vTextureCoord.x * uLayersPerRow ) + floor( vTextureCoord.y * uLayersPerRow ) * uLayersPerRow;  
            
            cubePos.xy *= uCubeSize;
            
            cubePos.xyz = floor(cubePos.xyz);
            
            cubePos.xyz -= vec3(uCubeSize*0.5);
            

            highp vec4 col = vec4( cubePos * 4.0, 1.0 );
            gl_FragColor = col;
        }
    </script>
</head>

<body onload="start()" style="margin: 0px;touch-action:none;overflow:hidden;">
    <div class="container">
        <canvas id="glcanvas" width="1200" height="480" style="width:100%;height:100%;">
            Your browser doesn't appear to support the <code>&lt;canvas&gt;</code> element.
        </canvas>
    </div>

</body>
</html>