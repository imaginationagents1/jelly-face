var Time=function(){Time.instance=this;this._lastFrameTime=this._currentTime=this._deltaTime=0};Time.instance=function(){};Time.prototype.update=function(a){this._currentTime=a;a=0;this._lastFrameTime&&(a=.001*(this._currentTime-this._lastFrameTime),1<a&&(a=0));this._deltaTime=a;this._lastFrameTime=this._currentTime};Time.deltaTime=function(){return Time.instance._deltaTime};Time.currentTime=function(){return Time.instance._currentTime};Time.lastFrameTime=function(){return Time.instance._lastFrameTime};
"use strict";
var Texture=function(a,b,c,d,e,f,g,h,k){c=void 0===c?gl.RGBA:c;d=void 0===d?gl.RGBA:d;e=void 0===e?gl.UNSIGNED_BYTE:e;f=void 0===f?gl.NEAREST:f;g=void 0===g?gl.NEAREST:g;h=void 0===h?gl.CLAMP_TO_EDGE:h;k=void 0===k?gl.CLAMP_TO_EDGE:k;this.nativeTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.nativeTexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,f);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,g);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,h);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,
k);gl.texImage2D(gl.TEXTURE_2D,0,c,a,b,0,d,e,null)};Texture.prototype["native"]=function(){return this.nativeTexture};
;
var Mesh=function(a,b,c,d){c=void 0===c?12:c;d=void 0===d?[[0,3]]:d;this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();this.stride=c;this.layout=d;this.elementCount=b.length;gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(a),gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint32Array(b),gl.STATIC_DRAW)};
Mesh.prototype.render=function(a){a=void 0===a?gl.TRIANGLES:a;gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);for(var b=0;b<this.layout.length;b++)gl.vertexAttribPointer(b,this.layout[b][1],gl.FLOAT,!1,this.stride,this.layout[b][0]);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.drawElements(a,this.elementCount,gl.UNSIGNED_INT,0)};"use strict";var Framebuffer=function(a,b,c,d){this._fbo=gl.createFramebuffer();this.setup(a,b,c,d)};
Framebuffer.prototype.setup=function(a,b,c,d){this._color=a;this._depth=b;this._width=c;this._height=d;gl.bindFramebuffer(gl.FRAMEBUFFER,this._fbo);this._fbo.width=this._width;this._fbo.height=this._height;if(this._color)for(a=0;a<this._color.length;++a)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+a,gl.TEXTURE_2D,this._color[a]["native"](),0);this._depth&&gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,this._depth["native"](),0)};
Framebuffer.prototype.color=function(a){return this._color[void 0===a?0:a]};Framebuffer.prototype.depth=function(){return this._depth};Framebuffer.prototype.fbo=function(){return this._fbo};Framebuffer.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._fbo);gl.viewport(0,0,this._width,this._height)};Framebuffer.bindDefault=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,canvas.width,canvas.height)};"use strict";
var FaceCullModeEnum={FRONT:0,BACK:1,BOTH:2,NONE:3},vertexAttributeToggler={currAttributes:0,enable:function(a){for(var b=0;32>b;b+=1){var c=1<<b&this.currAttributes;c!=(1<<b&a)&&(0!=c?gl.disableVertexAttribArray(b):gl.enableVertexAttribArray(b))}this.currAttributes=a}},Material=function(a,b){null!=a&&null!=b&&(this.shaderProgram=gl.createProgram(),gl.attachShader(this.shaderProgram,a),gl.attachShader(this.shaderProgram,b),gl.linkProgram(this.shaderProgram),gl.getProgramParameter(this.shaderProgram,
gl.LINK_STATUS)||alert("Unable to initialize the shader program: "+gl.getProgramInfoLog(this.shaderProgram)));this.textureAttributes=[];this.floatAttributes=[];this.vertexAttributes=[];this.matrixAttributes=[];this.vec3Attributes=[];this.vec2Attributes=[];this._cullMode=FaceCullModeEnum.BACK;this.vAttribBits=0};Material.prototype.setTexture=function(a,b){this.textureAttributes[a]=[gl.getUniformLocation(this.shaderProgram,a),b]};
Material.prototype.setFloat=function(a,b){this.floatAttributes[a]=[gl.getUniformLocation(this.shaderProgram,a),b]};Material.prototype.setMatrix=function(a,b){this.matrixAttributes[a]=[gl.getUniformLocation(this.shaderProgram,a),b]};Material.prototype.setVec2=function(a,b){this.vec2Attributes[a]=[gl.getUniformLocation(this.shaderProgram,a),b]};Material.prototype.getVec2=function(a){return this.vec2Attributes[a]};
Material.prototype.setVec3=function(a,b){this.vec3Attributes[a]=[gl.getUniformLocation(this.shaderProgram,a),b]};Material.prototype.getVec3=function(a){return this.vec3Attributes[a]};Material.prototype.setShader=function(a){this.shaderProgram=a};
Material.prototype.addVertexAttribute=function(a){var b=gl.getAttribLocation(this.shaderProgram,a);gl.enableVertexAttribArray(b);this.vertexAttributes[a]=b;_supportsWebGL2||gl.disableVertexAttribArray(b);this.vAttribBits=0;for(a in this.vertexAttributes)this.vAttribBits|=1<<this.vertexAttributes[a];return b};Material.prototype.getVertexAttribute=function(a){return this.vertexAttributes[a]};Material.prototype.setCull=function(a){this._cullMode=a};
Material.prototype.apply=function(){switch(this._cullMode){case FaceCullModeEnum.FRONT:gl.enable(gl.CULL_FACE);gl.cullFace(gl.FRONT);break;case FaceCullModeEnum.BACK:gl.enable(gl.CULL_FACE);gl.cullFace(gl.BACK);break;case FaceCullModeEnum.BOTH:gl.enable(gl.CULL_FACE);gl.cullFace(gl.FRONT_AND_BACK);break;case FaceCullModeEnum.NONE:gl.disable(gl.CULL_FACE)}gl.useProgram(this.shaderProgram);var a=0,b;for(b in this.textureAttributes)gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(gl.TEXTURE_2D,this.textureAttributes[b][1]),
gl.uniform1i(this.textureAttributes[b][0],a),a++;for(b in this.floatAttributes)gl.uniform1f(this.floatAttributes[b][0],this.floatAttributes[b][1]);for(b in this.matrixAttributes)gl.uniformMatrix4fv(this.matrixAttributes[b][0],!1,this.matrixAttributes[b][1]);for(b in this.vec3Attributes)gl.uniform3fv(this.vec3Attributes[b][0],this.vec3Attributes[b][1]);for(b in this.vec2Attributes)gl.uniform2fv(this.vec2Attributes[b][0],this.vec2Attributes[b][1]);if(!_supportsWebGL2)for(b in this.vertexAttributes)gl.enableVertexAttribArray(this.vertexAttributes[b])};
Material.prototype.unapply=function(){if(!_supportsWebGL2)for(var a in this.vertexAttributes)gl.disableVertexAttribArray(this.vertexAttributes[a]);gl.enable(gl.CULL_FACE)};
Material.getShader=function(a,b){var c=document.getElementById(b);if(!c)return null;for(var d="",e=c.firstChild;e;)3==e.nodeType&&(d+=e.textContent),e=e.nextSibling;if("x-shader/x-fragment"==c.type)c=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"==c.type)c=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(c,d);a.compileShader(c);return a.getShaderParameter(c,a.COMPILE_STATUS)?c:(alert("An error occurred compiling the shaders: "+a.getShaderInfoLog(c)),null)};
Material.createShader=function(a,b){var c=gl.createShader(b);gl.shaderSource(c,a);gl.compileShader(c);return gl.getShaderParameter(c,gl.COMPILE_STATUS)?c:(alert("An error occurred compiling the shaders: "+gl.getShaderInfoLog(c)),null)};function loadVBO(a,b,c){var d=new DataView(a),e=d.getUint32(0),f=d.getUint32(4);d=new Float32Array(a,8,e*b/4);a=new Uint32Array(a,8+e*b,f);return new Mesh(d,a,b,c)}
function loadVBOFromURL(a,b,c,d){var e=new XMLHttpRequest;e.onreadystatechange=function(){e.readyState==e.DONE&&200==e.status&&e.response&&d(loadVBO(e.response,b,c))};e.open("GET",a,!0);e.responseType="arraybuffer";e.send()}"use strict";
var JellyFace=function(){this._cubeBatch=null;this._voxelMaterials=[];this._voxelMaterialIndex=0;this._screenColorFbo=this._screenFbo=this._velFbo=this._posFbo=this._copyFbo=this._floorMesh=this._screenQuadMesh=null;this._copyMaterial;this._posMaterial;this._velMaterial;this._floorMaterials=[];this._composeMaterial=this._floorColorMaterial=null;this._pMatrix=[];this._vMatrix=[];this._mMatrix=[];this._cameraRotation=[];this._cameraPosition=[];this._modelRotation=[];this._modelPosition=[];this._modelScale=
[];this._faceMaterials=[];this._grabBuffer=this._faceColorBuffer=this._grabMaterial=null;this._faceLoaded=!1;this._faceColorSize=4096;this._shadowFboSize=2048;this._shadowScreenScale=.5;this._shadowScreenMaterial=this._shadowScreenFbo=this._shadowFbo=null;this._lightPosition=[];this._lightRotation=[];this._lightPerspective=[];this._lightView=[];this._lightVP=[];this._lightMVP=[];this._shadowsEnabled=!0;this.vColorFS=null};JellyFace.RT_TEX_SIZE=function(){return 512};
JellyFace.prototype.loadFace=function(a,b){this._faceLoaded=!1;var c=this,d=a+".vbo",e=a+".jpg";c.init();loadVBOFromURL(d,24,[[0,3],[12,2],[20,1]],function(a){c._faceMesh=a;a=Material.createShader(shaders.vs.initPos,gl.VERTEX_SHADER);a=new Material(a,c.vColorFS);a.addVertexAttribute("aPos");a.addVertexAttribute("aVertexID");a.setMatrix("uPMatrix",c._pMatrix);a.setMatrix("uVMatrix",c._vMatrix);a.setMatrix("uMMatrix",c._mMatrix);a.setFloat("uImageSize",JellyFace.RT_TEX_SIZE());gl.viewport(0,0,JellyFace.RT_TEX_SIZE(),
JellyFace.RT_TEX_SIZE());gl.clearColor(0,0,0,0);c.renderDataBuffer(c._posFbo.fbo(),a,c._faceMesh,gl.POINTS);gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,canvas.width,canvas.height);loadImageFromUrl(e,function(){b()})})};
JellyFace.prototype.getFloat32Format=function(){var a=gl.FLOAT,b=gl.RGBA;if(_supportsWebGL2){var c=gl.getExtension("EXT_color_buffer_float");null!=c?b=gl.RGBA32F:alert("This experiment requires the WebGL 2.0 extension EXT_color_buffer_float. Maybe try another web browser.")}else c=gl.getExtension("OES_texture_float"),null==c&&(c=gl.getExtension("OES_texture_half_float"),null!=c?a=c.HALF_FLOAT_OES:alert("This experiment requires the WebGL extension OES_texture_float or OES_texture_half_float. Maybe try another web browser.")),
null==gl.getExtension("OES_element_index_uint")&&alert("This experiment requires WebGL 2.0 or the WebGL 1.0 extension OES_element_index_uint. Maybe try another web browser.");return{texelData:a,internalFormat:b}};
JellyFace.prototype.initTransforms=function(){mat4.perspective(this._pMatrix,45,canvas.width/canvas.height,.01,50);this._cameraRotation=quat.create();this._cameraPosition=vec3.fromValues(0,0,-1);this._cameraUp=vec3.fromValues(0,1,0);this._modelRotation=quat.fromValues(0,0,0,1);this._modelPosition=vec3.fromValues(0,-.1,0);this._modelScale=vec3.fromValues(1,1,1);mat4.fromRotationTranslation(this._vMatrix,this._cameraRotation,this._cameraPosition);mat4.fromRotationTranslation(this._mMatrix,this._modelRotation,
this._modelPosition);this._lightPosition=vec3.fromValues(0,0,-3);this._lightRotation=quat.create();quat.rotateX(this._lightRotation,this._lightRotation,.678);quat.rotateY(this._lightRotation,this._lightRotation,-.3);quat.rotateX(this._lightRotation,this._lightRotation,-.3);quat.rotateZ(this._lightRotation,this._lightRotation,-.1);mat4.fromRotationTranslation(this._lightView,this._lightRotation,this._lightPosition);mat4.ortho(this._lightPerspective,-.9,.9,-.9,.9,1,5);mat4.multiply(this._lightVP,this._lightPerspective,
this._lightView)};
JellyFace.prototype.initParticleData=function(){var a=this.getFloat32Format(),b=a.texelData;a=a.internalFormat;this._posFbo=new Framebuffer([new Texture(JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE(),a,gl.RGBA,b)],null,JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE());this._velFbo=new Framebuffer([new Texture(JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE(),a,gl.RGBA,b)],null,JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE());this._copyFbo=new Framebuffer([new Texture(JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE(),
a,gl.RGBA,b)],null,JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE());this._grabBuffer=new Framebuffer([new Texture(JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE(),a,gl.RGBA,b)],null,JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE());var c=_supportsWebGL2?gl.DEPTH_COMPONENT24:gl.DEPTH_COMPONENT;this._shadowFbo=new Framebuffer([new Texture(this._shadowFboSize,this._shadowFboSize,a,gl.RGBA,b)],new Texture(this._shadowFboSize,this._shadowFboSize,c,gl.DEPTH_COMPONENT,gl.UNSIGNED_INT),this._shadowFboSize,
this._shadowFboSize);this._faceColorBuffer=new Framebuffer([new Texture(this._faceColorSize,this._faceColorSize,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE)],null,this._faceColorSize,this._faceColorSize);this.setupScreenBuffer();this._screenQuadMesh=new Mesh(quadVertices,quadVertexIndices);this._floorMesh=new Mesh(floorVertices,floorIndices);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);b=Material.createShader(shaders.vs.quad,gl.VERTEX_SHADER);a=Material.createShader(shaders.fs.copy,
gl.FRAGMENT_SHADER);c=Material.createShader(shaders.fs.pos,gl.FRAGMENT_SHADER);var d=Material.createShader(shaders.fs.compose,gl.FRAGMENT_SHADER),e=Material.createShader(shaders.fs.shadowBuffer,gl.FRAGMENT_SHADER),f=Material.createShader(shaders.vs.vel,gl.VERTEX_SHADER),g=Material.createShader(shaders.vs.grab,gl.VERTEX_SHADER);this.vColorFS=Material.createShader(shaders.fs.vColor,gl.FRAGMENT_SHADER);var h=Material.createShader(shaders.vs.floor,gl.VERTEX_SHADER),k=Material.createShader(shaders.fs.floor,
gl.FRAGMENT_SHADER);this._velMaterial=new Material(f,this.vColorFS);this._velMaterial.setTexture("uPosTex",this._posFbo.color()["native"]());this._velMaterial.setTexture("uVelTex",this._velFbo.color()["native"]());this._velMaterial.setTexture("uGrabTex",this._grabBuffer.color()["native"]());this._velMaterial.addVertexAttribute("aPos");this._velMaterial.addVertexAttribute("aVertexID");this._velMaterial.setFloat("uRadius",.25);this._velMaterial.setFloat("uAspect",canvas.height/canvas.width);this._velMaterial.setFloat("uImageSize",
JellyFace.RT_TEX_SIZE());this._posMaterial=new Material(b,c);this._posMaterial.setTexture("uPosTex",this._posFbo.color()["native"]());this._posMaterial.setTexture("uVelTex",this._velFbo.color()["native"]());this._posMaterial.addVertexAttribute("aPos");this._posMaterial.setFloat("uImageSize",JellyFace.RT_TEX_SIZE());this._grabMaterial=new Material(g,this.vColorFS);this._grabMaterial.setTexture("uPosTex",this._posFbo.color()["native"]());this._grabMaterial.addVertexAttribute("aVertexID");this._grabMaterial.setFloat("uRadius",
.25);this._grabMaterial.setFloat("uAspect",canvas.height/canvas.width);this._grabMaterial.setFloat("uImageSize",JellyFace.RT_TEX_SIZE());this._copyMaterial=new Material(b,a);this._copyMaterial.setTexture("uCopyTex",this._copyFbo.color()["native"]());this._copyMaterial.addVertexAttribute("aPos");this._composeMaterial=new Material(b,d);this._composeMaterial.setTexture("uShadowTex",this._shadowScreenFbo.color()["native"]());this._composeMaterial.addVertexAttribute("aPos");this._composeMaterial.setFloat("uAspect",
canvas.height/canvas.width);this._shadowScreenMaterial=new Material(b,e);this._shadowScreenMaterial.setTexture("uShadowTex",this._shadowFbo.color()["native"]());this._shadowScreenMaterial.addVertexAttribute("aPos");this._shadowScreenMaterial.setFloat("uAspect",canvas.height/canvas.width);this._floorMaterials=[new Material(h,k)];for(b=0;b<this._floorMaterials.length;++b)this._floorMaterials[b].addVertexAttribute("aPos"),this._floorMaterials[b].setMatrix("uPMatrix",this._pMatrix),this._floorMaterials[b].setMatrix("uVMatrix",
this._vMatrix),this._floorMaterials[b].setMatrix("uMMatrix",this._mMatrix)};
JellyFace.prototype.initMaterials=function(){this._voxelMaterials.length=2;var a=Material.createShader(shaders.vs.face,gl.VERTEX_SHADER),b=Material.createShader(shaders.fs.face,gl.FRAGMENT_SHADER);this._faceMaterials.push(new Material(a,b));_supportsWebGL2||(b=Material.createShader(shaders.fs.faceCol,gl.FRAGMENT_SHADER),this._faceMaterials.push(new Material(a,b)));for(a=0;a<this._faceMaterials.length;++a)this._faceMaterials[a].addVertexAttribute("aTexcoord"),this._faceMaterials[a].addVertexAttribute("aVertexID"),
_supportsWebGL2||this._faceMaterials[a].addVertexAttribute("aPos"),this._faceMaterials[a].setTexture("uColorTex",this._faceColorBuffer.color()["native"]()),this._faceMaterials[a].setTexture("uPosTex",this._posFbo.color()["native"]()),this._faceMaterials[a].setTexture("uVelTex",this._velFbo.color()["native"]()),this._faceMaterials[a].setVec2("uTexelSize",[1/this._faceColorBuffer._width,1/this._faceColorBuffer._height]),this._faceMaterials[a].setFloat("uImageSize",JellyFace.RT_TEX_SIZE()),this._faceMaterials[a].setMatrix("uPMatrix",
this._pMatrix),this._faceMaterials[a].setMatrix("uVMatrix",this._vMatrix),this._faceMaterials[a].setMatrix("uMMatrix",this._mMatrix);this._velMaterial.setMatrix("uPMatrix",this._pMatrix);this._velMaterial.setMatrix("uVMatrix",this._vMatrix);this._velMaterial.setMatrix("uMMatrix",this._mMatrix);this._grabMaterial.setMatrix("uPMatrix",this._pMatrix);this._grabMaterial.setMatrix("uVMatrix",this._vMatrix);this._grabMaterial.setMatrix("uMMatrix",this._mMatrix);this._shadowScreenMaterial.setMatrix("uLightSpace",
this._lightVP);this.updateScreenBufferMaterials()};
JellyFace.prototype.setupScreenBuffer=function(){var a=gl.UNSIGNED_BYTE,b=_supportsWebGL2?gl.DEPTH_COMPONENT24:gl.DEPTH_COMPONENT,c=this.getFloat32Format(),d=canvas.width,e=canvas.height,f=[new Texture(d,e,c.internalFormat,gl.RGBA,c.texelData)];_supportsWebGL2&&f.push(new Texture(d,e,gl.RGBA,gl.RGBA,a));c=new Texture(d,e,b,gl.DEPTH_COMPONENT,gl.UNSIGNED_INT);this._screenFbo?this._screenFbo.setup(f,c,d,e):this._screenFbo=new Framebuffer(f,c,d,e);_supportsWebGL2||(f=[new Texture(d,e,gl.RGBA,gl.RGBA,
a)],this._screenColorFbo?this._screenColorFbo.setup(f,c,d,e):this._screenColorFbo=new Framebuffer(f,c,d,e));d*=this._shadowScreenScale;e*=this._shadowScreenScale;a=[new Texture(d,e,gl.RGBA,gl.RGBA,a,gl.LINEAR,gl.LINEAR)];b=new Texture(d,e,b,gl.DEPTH_COMPONENT,gl.UNSIGNED_INT);this._shadowScreenFbo?this._shadowScreenFbo.setup(a,b,d,e):this._shadowScreenFbo=new Framebuffer(a,b,d,e);this.updateScreenBufferMaterials()};
JellyFace.prototype.updateScreenBufferMaterials=function(){var a=canvas.width,b=canvas.height;this._composeMaterial&&(_supportsWebGL2?this._composeMaterial.setTexture("uColTex",this._screenFbo.color(1)["native"]()):this._composeMaterial.setTexture("uColTex",this._screenColorFbo.color(0)["native"]()),this._composeMaterial.setTexture("uPosTex",this._screenFbo.color(0)["native"]()),this._composeMaterial.setFloat("uAspect",b/a),this._composeMaterial.setTexture("uShadowTex",this._shadowScreenFbo.color()["native"]()));
this._shadowScreenMaterial&&(_supportsWebGL2?this._shadowScreenMaterial.setTexture("uColTex",this._screenFbo.color(1)["native"]()):this._shadowScreenMaterial.setTexture("uColTex",this._screenColorFbo.color(0)["native"]()),this._shadowScreenMaterial.setTexture("uPosTex",this._screenFbo.color(0)["native"]()),this._shadowScreenMaterial.setFloat("uAspect",b/a));this._velMaterial&&(this._velMaterial.setVec2("uCanvasSize",new Float32Array([a,b])),this._velMaterial.setFloat("uAspect",b/a));this._grabMaterial&&
this._grabMaterial.setTexture("uScreenPosTex",this._screenFbo.color(0)["native"]())};JellyFace.prototype.blit=function(a,b,c,d){gl.viewport(0,0,c,d);this._copyMaterial.setTexture("uCopyTex",a);gl.bindFramebuffer(gl.FRAMEBUFFER,b);gl.clear(gl.COLOR_BUFFER_BIT);this._copyMaterial.apply();this._screenQuadMesh.render();this._copyMaterial.unapply();this._copyMaterial.setTexture("uCopyTex",this._copyFbo.color()["native"]());Framebuffer.bindDefault()};
JellyFace.prototype.handleTextureLoaded=function(a,b){gl.bindTexture(gl.TEXTURE_2D,b);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,gl.RGB,gl.UNSIGNED_BYTE,a);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.bindTexture(gl.TEXTURE_2D,null);this.blit(b,this._faceColorBuffer.fbo(),this._faceColorSize,
this._faceColorSize);this._faceLoaded=!0};JellyFace.prototype.renderDataBuffer=function(a,b,c,d){d=void 0===d?gl.TRIANGLES:d;gl.bindFramebuffer(gl.FRAMEBUFFER,this._copyFbo.fbo());gl.clear(gl.COLOR_BUFFER_BIT);b.apply();c.render(d);b.unapply();gl.bindFramebuffer(gl.FRAMEBUFFER,a);gl.clear(gl.COLOR_BUFFER_BIT);this._copyMaterial.apply();this._screenQuadMesh.render();this._copyMaterial.unapply()};
JellyFace.prototype.renderParticleData=function(a){gl.viewport(0,0,JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE());gl.clearColor(0,0,0,0);this._posMaterial.setFloat("uDeltaTime",a);this._velMaterial.setFloat("uDeltaTime",a);this.renderDataBuffer(this._velFbo.fbo(),this._velMaterial,this._faceMesh,gl.POINTS);this.renderDataBuffer(this._posFbo.fbo(),this._posMaterial,this._screenQuadMesh);Framebuffer.bindDefault()};
JellyFace.prototype.renderShadows=function(){this._faceMaterials[0].setMatrix("uPMatrix",this._lightPerspective);this._faceMaterials[0].setMatrix("uVMatrix",this._lightView);this._shadowFbo.bind();gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);this._faceMaterials[0].apply();this._faceMesh.render();this._faceMaterials[0].unapply();this._faceMaterials[0].setMatrix("uPMatrix",this._pMatrix);this._faceMaterials[0].setMatrix("uVMatrix",this._vMatrix);Framebuffer.bindDefault()};
JellyFace.prototype.init=function(){this.initTransforms();this.initParticleData();this.initMaterials()};
JellyFace.prototype.update=function(){mat4.fromRotationTranslation(this._vMatrix,this._cameraRotation,this._cameraPosition);mat4.fromRotationTranslationScale(this._mMatrix,this._modelRotation,this._modelPosition,this._modelScale);this._faceMaterials[0].setMatrix("uMMatrix",this._mMatrix);this._faceMaterials[0].setMatrix("uVMatrix",this._vMatrix);this._velMaterial.setMatrix("uMMatrix",this._mMatrix);this._velMaterial.setMatrix("uVMatrix",this._vMatrix);this._grabMaterial.setMatrix("uMMatrix",this._mMatrix);
this._grabMaterial.setMatrix("uVMatrix",this._vMatrix);var a=[];mat4.multiply(a,this._pMatrix,this._vMatrix);mat4.invert(a,a);this._velMaterial.setMatrix("uInvMVPMatrix",a);this._grabMaterial.setMatrix("uInvMVPMatrix",a)};JellyFace.prototype.postUpdate=function(){};
JellyFace.prototype.debugPosBuffer=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,512,512);this._copyMaterial.setTexture("uCopyTex",this._shadowFbo.color()["native"]());this._copyMaterial.apply();this._screenQuadMesh.render();this._copyMaterial.unapply();this._copyMaterial.setTexture("uCopyTex",this._copyFbo.color()["native"]())};
JellyFace.prototype.render=function(){this._faceLoaded&&this.renderParticleData(Time.deltaTime());this._screenFbo.bind();_supportsWebGL2&&gl.drawBuffers([gl.COLOR_ATTACHMENT0,gl.COLOR_ATTACHMENT1]);gl.clearColor(.5,.5,.5,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);this._faceLoaded&&(this._faceMaterials[0].apply(),this._faceMesh.render(),this._faceMaterials[0].unapply(),_supportsWebGL2&&gl.drawBuffers([gl.COLOR_ATTACHMENT0]),this._floorMaterials[0].apply(),this._floorMesh.render(),this._floorMaterials[0].unapply(),
_supportsWebGL2||(this._screenColorFbo.bind(),gl.clearColor(.5,.5,.5,0),gl.clear(gl.COLOR_BUFFER_BIT),this._faceMaterials[1].apply(),this._faceMesh.render(),this._faceMaterials[1].unapply()));this._shadowsEnabled&&(this._faceLoaded&&this.renderShadows(),this._shadowScreenFbo.bind(),gl.clearColor(1,1,1,1),gl.clear(gl.COLOR_BUFFER_BIT),this._shadowScreenMaterial.apply(),this._screenQuadMesh.render(),this._shadowScreenMaterial.unapply());Framebuffer.bindDefault();gl.clear(gl.COLOR_BUFFER_BIT);this._composeMaterial.apply();
this._screenQuadMesh.render();this._composeMaterial.unapply()};
JellyFace.prototype.handleResize=function(){mat4.perspective(this._pMatrix,45,canvas.width/canvas.height,.01,50);for(var a=0;a<this._faceMaterials.length;++a)this._faceMaterials[a].setMatrix("uPMatrix",this._pMatrix);this._velMaterial.setMatrix("uPMatrix",this._pMatrix);this._grabMaterial.setMatrix("uPMatrix",this._pMatrix);for(a=0;a<this._floorMaterials.length;++a)this._floorMaterials[a].setMatrix("uPMatrix",this._pMatrix);gl.viewport(0,0,canvas.width,canvas.height);this.setupScreenBuffer()};
JellyFace.prototype.handleZoom=function(a){var b=this._cameraPosition[2];b+=.1*a;-3>b?b=-3:-.5<b&&(b=-.5);this._cameraPosition[2]=b};JellyFace.prototype.handleRotate=function(a,b){var c=quat.create();quat.rotateX(c,c,30*b);c=quat.create();quat.rotateY(c,c,5*a);quat.multiply(this._modelRotation,c,this._modelRotation)};
JellyFace.prototype.startToolUse=function(){gl.viewport(0,0,JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE());gl.clearColor(0,0,0,0);this.renderDataBuffer(this._grabBuffer.fbo(),this._grabMaterial,this._faceMesh,gl.POINTS);Framebuffer.bindDefault()};JellyFace.prototype.endToolUse=function(){gl.viewport(0,0,JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE());gl.clearColor(0,0,0,0);gl.bindFramebuffer(gl.FRAMEBUFFER,this._grabBuffer.fbo());gl.clear(gl.COLOR_BUFFER_BIT);Framebuffer.bindDefault()};
JellyFace.prototype.handleToolUse=function(a,b){this._velMaterial.setVec3("uMousePos",[.5*a+.5,.5*b+.5,-1]);this._grabMaterial.setVec3("uMousePos",[.5*a+.5,.5*b+.5,-1])};JellyFace.prototype.handleMouseMove=function(a,b){this._velMaterial.setVec3("uMousePos",[.5*a+.5,.5*b+.5,-1]);this._grabMaterial.setVec3("uMousePos",[.5*a+.5,.5*b+.5,-1])};JellyFace.prototype.changeBrushSize=function(a){this._velMaterial.setFloat("uRadius",a)};JellyFace.prototype.setVoxelMaterialIndex=function(a){};
JellyFace.prototype.getVoxTextureCPU=function(){this._posFbo.bind();var a=new Uint8Array(JellyFace.RT_TEX_SIZE()*JellyFace.RT_TEX_SIZE()*4);gl.readPixels(0,0,JellyFace.RT_TEX_SIZE(),JellyFace.RT_TEX_SIZE(),gl.RGBA,gl.UNSIGNED_BYTE,a);Framebuffer.bindDefault();return a};
var quadVertices=[-1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1],quadVertexIndices=[0,1,2,0,2,3],floorVertices=[-10,-.5,-10,-10,-.5,10,10,-.5,10,10,-.5,-10],floorIndices=quadVertexIndices,canvas,gl,leftDown=!1,rightDown=!1,lastMouseX=null,lastMouseY=null,mouseCoord=[],touches=[],_pullCube=null,_time=null,_started=!0,_firstUpdate=!0,_supportsWebGL2=!1,shaders=null,stats=new Stats,models="snoop charlize jackie shatner obama marilyn".split(" "),credits='<a href="https://sketchfab.com/models/27c0788205264c7bac3b734e2733413c">Snoop Dogg</a> by <a href="https://sketchfab.com/tipatat">tipatat</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0">CC Attribution</a>;<a href="https://sketchfab.com/models/687ee1b6d7234ac4a4797f09435d8ab3">Charlize Theron</a> by <a href="https://sketchfab.com/tipatat">tipatat</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0">CC Attribution</a>;<a href="https://sketchfab.com/models/093b1edcac344c8bb272e1967aeac30c">Jackie Chan</a> by <a href="https://sketchfab.com/tipatat">tipatat</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0">CC Attribution</a>;<a href="https://sketchfab.com/models/5a4534d44b2c4244be9cd0a75fa81866">William Shatner</a> by <a href="https://sketchfab.com/tipatat">tipatat</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0">CC Attribution</a>;<a href="https://sketchfab.com/models/92589e6f710f409dbc1e9edbe26eb1bd">President Obama</a> by <a href="https://sketchfab.com/tipatat">tipatat</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0">CC Attribution</a>;<a href="https://sketchfab.com/models/ab61515e456549fd9d6e4caff91060ae">Marilyn Monroe</a> by <a href="https://sketchfab.com/tipatat">tipatat</a> is licensed under <a href="http://creativecommons.org/licenses/by/4.0">CC Attribution</a>'.split(";"),
modelIndex=0;
function start(){stats.showPanel(0);document.body.appendChild(stats.dom);canvas=document.getElementById("glcanvas");canvas.width=window.innerWidth;canvas.height=window.innerHeight;initWebGL(canvas);if(gl){gl.clearColor(0,0,0,1);gl.clearDepth(1);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LEQUAL);gl.enable(gl.CULL_FACE);gl.cullFace(gl.BACK);gl.disable(gl.BLEND);_time=new Time;var a="./shaders/gles20";_supportsWebGL2&&(a="./shaders/gles30");shaders=new ShaderLoader(a,"./shaders/util");shaders.load("composeFS","compose",
"fragment");shaders.load("copyFS","copy","fragment");shaders.load("faceVS","face","vertex");shaders.load("floorVS","floor","vertex");shaders.load("grabVS","grab","vertex");shaders.load("initPosVS","initPos","vertex");shaders.load("posFS","pos","fragment");shaders.load("screenQuadVS","quad","vertex");shaders.load("shadowBufferFS","shadowBuffer","fragment");shaders.load("vColorFS","vColor","fragment");shaders.load("velVS","vel","vertex");_supportsWebGL2?(shaders.load("faceFS","face","fragment"),shaders.load("floorFS",
"floor","fragment")):(shaders.load("facePosFS","face","fragment"),shaders.load("floorPosFS","floor","fragment"),shaders.load("faceColFS","faceCol","fragment"),shaders.load("floorColFS","floorCol","fragment"));_pullCube=new JellyFace;-1<window.orientation&&(_pullCube._shadowFboSize=768,_pullCube._shadowScreenScale=.25);shaders.shaderSetLoaded=function(){loadFace(modelIndex)}}else alert("sorry, your browser/device does not support the webgl compabilities this application needs.")}
function loadFace(a){vertexAttributeToggler.currAttributes=0;_pullCube.loadFace("./assets/"+models[a],ready);document.getElementById("attributions").innerHTML=credits[a]}
function ready(){_firstUpdate&&(canvas.onmousedown=handleMouseDown,canvas.oncontextmenu=handleRightClick,canvas.onmouseup=handleMouseUp,canvas.onmousemove=handleMouseMove,canvas.addEventListener("onmousewheel"in document?"mousewheel":"wheel",function(a){a.wheel=a.wheelDelta?a.wheelDelta/40:-a.deltaY;handleMouseWheel(a)}),canvas.addEventListener("touchmove",function(a){a.preventDefault();handleTouchMove(a)},!1),canvas.addEventListener("touchstart",function(a){a.preventDefault();handleTouchStart(a)},
!1),canvas.addEventListener("touchend",function(a){a.preventDefault();handleTouchEnd(a)},!1),requestAnimationFrame(tick))}function render(){_pullCube.render()}function tick(a){stats.begin();_time.update(a);if(_started||_firstUpdate)resize(),_pullCube.update(),render(),_pullCube.postUpdate(),_firstUpdate=!1;stats.end();requestAnimationFrame(tick)}
function initWebGL(){gl=null;try{gl=canvas.getContext("webgl2",{alpha:!1});var a=gl.getSupportedExtensions();console.log(a)}catch(b){}gl?_supportsWebGL2=!0:(gl=canvas.getContext("experimental-webgl",{alpha:!1}),a=gl.getSupportedExtensions(),console.log(a),gl.getExtension("WEBGL_depth_texture"));console.log("supports webgl 2: "+_supportsWebGL2);gl||alert("Unable to initialize WebGL. Your browser may not support it.")}
function initUI(){document.getElementById("fileItem").addEventListener("change",handleLoadImage,!1)}function tutorialOff(){document.getElementById("overlayTutorial").style.display="none";_started=!0}
function handleLoadImage(a){a=a.target.files[0];var b=new FileReader;a.type.match("image.*")?(b.onload=function(a){return function(a){loadVoxelTexture(a.target.result)}}(a),b.readAsDataURL(a)):a.name.endsWith(".vox")&&(b.onload=function(a){return function(a){var b=gl.createTexture();_pullCube.handleTextureLoaded(importMagicaVoxel(a.target.result,""),b)}}(a),b.readAsArrayBuffer(a))}
function loadImageFromUrl(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(c.readyState==c.DONE&&200==c.status&&c.response){var a=new FileReader;a.onload=function(a){return function(a){loadVoxelTexture(a.target.result);b()}}(c.response);a.readAsDataURL(c.response)}};c.open("GET",a,!0);c.responseType="blob";c.send()}function loadVoxelTexture(a){var b=gl.createTexture(),c=new Image;c.onload=function(){_pullCube.handleTextureLoaded(c,b)};c.src=a}
function saveVoxelTexture(){var a=_pullCube.getVoxTextureCPU();a=new BMPEnc(a,JellyFace.RT_TEX_SIZE,JellyFace.RT_TEX_SIZE,!0);a=new Blob([a.encode()],{type:"image/bmp"});saveAs(a,"voxsculpt.bmp")}function resize(){var a=window.innerWidth,b=window.innerHeight;if(canvas.width!=a||canvas.height!=b)canvas.width=a,canvas.height=b,_pullCube.handleResize()}
function handlePointerMove(a,b,c,d,e,f){a=b-lastMouseX;var g=c-lastMouseY;null==f&&(f=.05*(a+g));f&&_pullCube.handleZoom(f);e&&_pullCube.handleRotate(a/window.innerWidth,0);e=b/window.innerWidth*2-1;f=1-c/window.innerHeight*2;d&&(mouseCoord=vec4.fromValues(e,f,-1,1),_pullCube.handleToolUse(e,f));_pullCube.handleMouseMove(e,f);lastMouseX=b;lastMouseY=c}
function handlePointerStart(a,b,c,d){b&&(mouseCoord=vec4.fromValues(lastMouseX/window.innerWidth*2-1,1-lastMouseY/window.innerHeight*2,-1,1),handlePointerMove(a,lastMouseX,lastMouseY,!0,!1,0),_pullCube.startToolUse())}function handlePointerEnd(a,b){b&&_pullCube.endToolUse()}
function handleMouseDown(a){lastMouseX=a.clientX;lastMouseY=a.clientY;var b;a.which?b=3==a.which:a.button&&(b=2==a.button);var c;a.which?c=1==a.which:a.button&&(c=0==a.button);b?rightDown=!0:leftDown=!0;var d=1==a.altKey;handlePointerStart(a,c,b&&!d,b&&d)}function handleMouseUp(a){var b;a.which?b=1==a.which:a.button&&(b=0==a.button);var c=leftDown;b?leftDown=!1:rightDown=!1;handlePointerEnd(a,c&&!leftDown)}
function handleMouseMove(a){var b=1==a.altKey;handlePointerMove(a,a.clientX,a.clientY,leftDown,rightDown&&!b,rightDown&&b?null:0)}function handleMouseWheel(a){_pullCube.handleZoom(a.wheel)}function handleRightClick(a){a.preventDefault();return!1}
function handleTouchStart(a){touches=a.touches;1==touches.length?(lastMouseX=touches[0].clientX,lastMouseY=touches[0].clientY):(2<=touches.length&&(lastMouseX=(touches[1].clientX+touches[0].clientX)/2,lastMouseY=(touches[1].clientY+touches[0].clientY)/2),handlePointerEnd(a,!0));lastTouchDist=-1;handlePointerStart(a,1==touches.length,3==touches.length,2==touches.length)}function handleTouchEnd(a){touches=a.touches;1!=touches.length&&handlePointerEnd(a,!0)}var lastTouchDist=-1;
function handleTouchMove(a){touches=a.touches;if(1==touches.length){leftDown=!0;rightDown=!1;var b=touches[0].clientX/1;var c=touches[0].clientY/1}else if(2<=touches.length)leftDown=!1,rightDown=!0,b=touches[0].clientX,c=touches[0].clientY;else{rightDown=leftDown=!1;return}var d=0;if(2==touches.length){var e=touches[1].clientX-touches[0].clientX,f=touches[1].clientY-touches[0].clientY;e=Math.sqrt(e*e+f*f);0<=lastTouchDist&&(d=e-lastTouchDist);lastTouchDist=e}handlePointerMove(a,b,c,1==touches.length,
3==touches.length,.03*d);return!1};